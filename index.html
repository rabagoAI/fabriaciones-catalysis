<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Fabricaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200 min-h-screen">
    <div id="app"></div>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://fwfgspbfmkcwduzsfjnk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3ZmdzcGJmbWtjd2R1enNmam5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyOTQyNDQsImV4cCI6MjA3Njg3MDI0NH0.XSPxU_lPY-w6OwCOUW3bYipyrDVLCdKjDtX8-4fPnCU';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Configuraci√≥n de emails para notificaciones
        // ‚ö†Ô∏è IMPORTANTE: Cambia este email por el tuyo para hacer pruebas
        const emailsNotificacion = ['tu-email@ejemplo.com']; // ‚Üê PON TU EMAIL AQU√ç

        // Estados
        const ESTADOS = {
            PENDIENTE: 'Pendiente',
            EN_PROCESO: 'En Proceso',
            COMPLETADA: 'Completada'
        };

        // Estado de la aplicaci√≥n
        let state = {
            fabricaciones: [],
            filtroEstado: 'todos',
            busqueda: '',
            vistaActual: 'lista',
            fabricacionSeleccionada: null,
            modoEdicion: false,
            usuarioActual: localStorage.getItem('usuarioActual') || 'Usuario',
            cargando: true,
            anioCalendario: new Date().getFullYear(),
            semanaSeleccionada: null
        };

        // Cargar fabricaciones
        async function cargarFabricaciones() {
            try {
                const { data, error } = await supabaseClient
                    .from('fabricaciones')
                    .select('*')
                    .order('anio', { ascending: true })
                    .order('numero_semana', { ascending: true });

                if (error) throw error;

                state.fabricaciones = data.map(fab => ({
                    id: fab.id,
                    numeroSemana: fab.numero_semana,
                    anio: fab.anio,
                    producto: fab.producto,
                    cantidad: fab.cantidad,
                    diasFabricacion: fab.dias_fabricacion,
                    fechaEntrega: fab.fecha_entrega,
                    observaciones: fab.observaciones,
                    estado: fab.estado,
                    solicitante: fab.solicitante,
                    fechaCreacion: fab.fecha_creacion,
                    historial: fab.historial || []
                }));
                state.cargando = false;
                render();
            } catch (error) {
                console.error('Error cargando fabricaciones:', error);
                alert('Error al cargar datos: ' + error.message);
                state.cargando = false;
                render();
            }
        }

        // Enviar notificaci√≥n por email
        async function enviarNotificacion(tipo, fabricacion) {
            try {
                const { data, error } = await supabaseClient.functions.invoke('enviar-notificacion-fabricacion', {
                    body: {
                        tipo: tipo, // 'nueva' o 'completada'
                        fabricacion: fabricacion,
                        emails: emailsNotificacion
                    }
                });
                
                if (error) {
                    console.error('Error enviando notificaci√≥n:', error);
                } else {
                    console.log('üìß Notificaci√≥n enviada correctamente');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Crear fabricaci√≥n
        async function crearFabricacion(datos) {
            try {
                const historial = [{
                    fecha: new Date().toISOString(),
                    accion: 'Creaci√≥n',
                    usuario: state.usuarioActual,
                    detalle: 'Fabricaci√≥n creada'
                }];

                const { data, error } = await supabaseClient
                    .from('fabricaciones')
                    .insert([{
                        numero_semana: parseInt(datos.numeroSemana),
                        anio: parseInt(datos.anio),
                        producto: datos.producto,
                        cantidad: parseInt(datos.cantidad),
                        dias_fabricacion: datos.diasFabricacion ? parseInt(datos.diasFabricacion) : null,
                        fecha_entrega: datos.fechaEntrega || null,
                        observaciones: datos.observaciones || null,
                        estado: ESTADOS.PENDIENTE,
                        solicitante: state.usuarioActual,
                        historial: historial
                    }])
                    .select();

                if (error) throw error;

                alert('‚úÖ Fabricaci√≥n creada correctamente');
                await cargarFabricaciones();

                // Enviar notificaci√≥n de nueva fabricaci√≥n
                await enviarNotificacion('nueva', {
                    producto: datos.producto,
                    numeroSemana: datos.numeroSemana,
                    anio: datos.anio,
                    cantidad: datos.cantidad,
                    observaciones: datos.observaciones,
                    solicitante: state.usuarioActual
                });
            } catch (error) {
                console.error('Error creando fabricaci√≥n:', error);
                alert('Error al crear fabricaci√≥n: ' + error.message);
            }
        }

        // Actualizar fabricaci√≥n
        async function actualizarFabricacion(id, cambios) {
            try {
                // Obtener fabricaci√≥n actual
                const fab = state.fabricaciones.find(f => f.id === id);
                if (!fab) return;

                const nuevoHistorial = [...fab.historial, {
                    fecha: new Date().toISOString(),
                    accion: 'Actualizaci√≥n',
                    usuario: state.usuarioActual,
                    detalle: Object.keys(cambios).map(key => `${key}: ${cambios[key]}`).join(', ')
                }];

                const updateData = {};
                if (cambios.numeroSemana) updateData.numero_semana = parseInt(cambios.numeroSemana);
                if (cambios.anio) updateData.anio = parseInt(cambios.anio);
                if (cambios.producto) updateData.producto = cambios.producto;
                if (cambios.cantidad) updateData.cantidad = parseInt(cambios.cantidad);
                if (cambios.diasFabricacion !== undefined) updateData.dias_fabricacion = cambios.diasFabricacion ? parseInt(cambios.diasFabricacion) : null;
                if (cambios.fechaEntrega !== undefined) updateData.fecha_entrega = cambios.fechaEntrega || null;
                if (cambios.observaciones !== undefined) updateData.observaciones = cambios.observaciones;
                if (cambios.estado) updateData.estado = cambios.estado;
                updateData.historial = nuevoHistorial;

                const { error } = await supabaseClient
                    .from('fabricaciones')
                    .update(updateData)
                    .eq('id', id);

                if (error) throw error;

                await cargarFabricaciones();

                // Si se marc√≥ como completada, enviar notificaci√≥n
                if (cambios.estado === ESTADOS.COMPLETADA) {
                    const fabActualizada = state.fabricaciones.find(f => f.id === id);
                    if (fabActualizada) {
                        await enviarNotificacion('completada', {
                            producto: fabActualizada.producto,
                            numeroSemana: fabActualizada.numeroSemana,
                            anio: fabActualizada.anio,
                            cantidad: fabActualizada.cantidad
                        });
                    }
                }
            } catch (error) {
                console.error('Error actualizando fabricaci√≥n:', error);
                alert('Error al actualizar fabricaci√≥n: ' + error.message);
            }
        }

        // Eliminar fabricaci√≥n
        async function eliminarFabricacion(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta fabricaci√≥n?')) return;

            try {
                const { error } = await supabaseClient
                    .from('fabricaciones')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('üóëÔ∏è Fabricaci√≥n eliminada');
                await cargarFabricaciones();
            } catch (error) {
                console.error('Error eliminando fabricaci√≥n:', error);
                alert('Error al eliminar fabricaci√≥n: ' + error.message);
            }
        }

        // Filtrar fabricaciones
        function getFabricacionesFiltradas() {
            return state.fabricaciones
                .filter(fab => state.filtroEstado === 'todos' || fab.estado === state.filtroEstado)
                .filter(fab => 
                    state.busqueda === '' || 
                    fab.producto.toLowerCase().includes(state.busqueda.toLowerCase()) ||
                    fab.numeroSemana.toString().includes(state.busqueda) ||
                    (fab.observaciones && fab.observaciones.toLowerCase().includes(state.busqueda.toLowerCase()))
                );
        }

        // Calcular estad√≠sticas
        function getEstadisticas() {
            return {
                total: state.fabricaciones.length,
                pendientes: state.fabricaciones.filter(f => f.estado === ESTADOS.PENDIENTE).length,
                enProceso: state.fabricaciones.filter(f => f.estado === ESTADOS.EN_PROCESO).length,
                completadas: state.fabricaciones.filter(f => f.estado === ESTADOS.COMPLETADA).length
            };
        }

        // Renderizar
        function render() {
            const app = document.getElementById('app');
            
            if (state.cargando) {
                app.innerHTML = `
                    <div class="flex items-center justify-center h-screen">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p class="text-gray-600">Cargando fabricaciones...</p>
                        </div>
                    </div>
                `;
                return;
            }

            const estadisticas = getEstadisticas();
            const fabricacionesFiltradas = getFabricacionesFiltradas();

            app.innerHTML = `
                <!-- Header -->
                <header class="bg-white shadow-md">
                    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <img src="https://res.cloudinary.com/ds7shn66t/image/upload/v1761819015/CATALYSISlogo_agz8kr.png" alt="Logo Catalysis" class="h-12 w-auto">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">Sistema de Fabricaciones</h1>
                                <p class="text-sm text-gray-600">Fabricaciones solicitadas</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <input
                                type="text"
                                id="usuarioInput"
                                value="${state.usuarioActual}"
                                placeholder="Tu nombre"
                                class="px-3 py-1 border border-gray-300 rounded-lg text-sm"
                            />
                        </div>
                    </div>
                </header>

                <div class="max-w-7xl mx-auto px-4 py-6">
                    <!-- Navegaci√≥n -->
                    <div class="flex gap-2 mb-6">
                        <button
                            onclick="cambiarVista('lista')"
                            class="px-4 py-2 rounded-lg font-medium transition ${state.vistaActual === 'lista' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'}"
                        >
                            Lista de Fabricaciones
                        </button>
                        <button
                            onclick="cambiarVista('calendario')"
                            class="px-4 py-2 rounded-lg font-medium transition flex items-center gap-2 ${state.vistaActual === 'calendario' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'}"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Calendario
                        </button>
                        <button
                            onclick="cambiarVista('estadisticas')"
                            class="px-4 py-2 rounded-lg font-medium transition flex items-center gap-2 ${state.vistaActual === 'estadisticas' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'}"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Estad√≠sticas
                        </button>
                    </div>

                    ${state.vistaActual === 'lista' ? renderLista(fabricacionesFiltradas, estadisticas) : ''}
                    ${state.vistaActual === 'calendario' ? renderCalendario() : ''}
                    ${state.vistaActual === 'estadisticas' ? renderEstadisticas() : ''}
                    ${state.vistaActual === 'historial' ? renderHistorial() : ''}
                </div>

                ${state.modoEdicion ? renderModal() : ''}
            `;

            // Event listeners
            const usuarioInput = document.getElementById('usuarioInput');
            if (usuarioInput) {
                usuarioInput.addEventListener('change', (e) => {
                    state.usuarioActual = e.target.value;
                    localStorage.setItem('usuarioActual', e.target.value);
                });
            }

            const busquedaInput = document.getElementById('busquedaInput');
            if (busquedaInput) {
                busquedaInput.addEventListener('input', (e) => {
                    state.busqueda = e.target.value;
                    render();
                });
            }

            const filtroSelect = document.getElementById('filtroEstado');
            if (filtroSelect) {
                filtroSelect.addEventListener('change', (e) => {
                    state.filtroEstado = e.target.value;
                    render();
                });
            }
        }

        function renderLista(fabricacionesFiltradas, estadisticas) {
            return `
                <!-- Controles -->
                <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="relative">
                            <svg class="absolute left-3 top-3 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input
                                type="text"
                                id="busquedaInput"
                                placeholder="Buscar por producto, semana u observaciones..."
                                value="${state.busqueda}"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                        </div>
                        <select
                            id="filtroEstado"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="todos" ${state.filtroEstado === 'todos' ? 'selected' : ''}>Todos los estados</option>
                            <option value="${ESTADOS.PENDIENTE}" ${state.filtroEstado === ESTADOS.PENDIENTE ? 'selected' : ''}>${ESTADOS.PENDIENTE}</option>
                            <option value="${ESTADOS.EN_PROCESO}" ${state.filtroEstado === ESTADOS.EN_PROCESO ? 'selected' : ''}>${ESTADOS.EN_PROCESO}</option>
                            <option value="${ESTADOS.COMPLETADA}" ${state.filtroEstado === ESTADOS.COMPLETADA ? 'selected' : ''}>${ESTADOS.COMPLETADA}</option>
                        </select>
                        <button
                            onclick="abrirModal(null)"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2 font-medium"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Nueva Fabricaci√≥n
                        </button>
                    </div>
                </div>

                <!-- Estad√≠sticas r√°pidas -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-lg shadow p-4">
                        <p class="text-sm text-gray-600">Total</p>
                        <p class="text-2xl font-bold text-gray-800">${estadisticas.total}</p>
                    </div>
                    <div class="bg-yellow-50 rounded-lg shadow p-4">
                        <p class="text-sm text-yellow-700">Pendientes</p>
                        <p class="text-2xl font-bold text-yellow-800">${estadisticas.pendientes}</p>
                    </div>
                    <div class="bg-blue-50 rounded-lg shadow p-4">
                        <p class="text-sm text-blue-700">En Proceso</p>
                        <p class="text-2xl font-bold text-blue-800">${estadisticas.enProceso}</p>
                    </div>
                    <div class="bg-green-50 rounded-lg shadow p-4">
                        <p class="text-sm text-green-700">Completadas</p>
                        <p class="text-2xl font-bold text-green-800">${estadisticas.completadas}</p>
                    </div>
                </div>

                <!-- Lista de fabricaciones -->
                <div class="space-y-4">
                    ${fabricacionesFiltradas.length === 0 ? `
                        <div class="bg-white rounded-lg shadow-md p-8 text-center">
                            <p class="text-gray-500 mb-4">
                                ${state.fabricaciones.length === 0 
                                    ? '¬°Empieza creando tu primera fabricaci√≥n!' 
                                    : 'No hay fabricaciones que coincidan con los filtros'}
                            </p>
                            ${state.fabricaciones.length === 0 ? `
                                <button
                                    onclick="abrirModal(null)"
                                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition"
                                >
                                    Crear Primera Fabricaci√≥n
                                </button>
                            ` : ''}
                        </div>
                    ` : fabricacionesFiltradas.map(fab => renderTarjeta(fab)).join('')}
                </div>
            `;
        }

        function renderTarjeta(fab) {
            const colorEstado = {
                [ESTADOS.PENDIENTE]: 'bg-yellow-100 text-yellow-800',
                [ESTADOS.EN_PROCESO]: 'bg-blue-100 text-blue-800',
                [ESTADOS.COMPLETADA]: 'bg-green-100 text-green-800'
            };

            const fecha = new Date(fab.fechaCreacion).toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            return `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-xl font-bold text-gray-800">${fab.producto}</h3>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${colorEstado[fab.estado]}">
                                    ${fab.estado}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600">Solicitado por: ${fab.solicitante}</p>
                            <p class="text-xs text-gray-500">${fecha}</p>
                        </div>
                        
                        <div class="flex gap-2">
                            <button
                                onclick="abrirModal(${fab.id})"
                                class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition"
                                title="Editar"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button
                                onclick="verHistorial(${fab.id})"
                                class="p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition"
                                title="Ver historial"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </button>
                            <button
                                onclick="eliminarFabricacion(${fab.id})"
                                class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition"
                                title="Eliminar"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-4 mb-4">
    <div>
        <p class="text-xs text-gray-500">Semana</p>
        <p class="text-lg font-semibold text-gray-800">#${fab.numeroSemana}</p>
    </div>
    <div>
        <p class="text-xs text-gray-500">A√±o</p>
        <p class="text-lg font-semibold text-gray-800">${fab.anio || 'N/A'}</p>
    </div>
    <div>
        <p class="text-xs text-gray-500">Cantidad</p>
        <p class="text-lg font-semibold text-gray-800">${fab.cantidad}</p>
    </div>
    <div>
        <p class="text-xs text-gray-500">Fecha Fabricaci√≥n</p>
        <p class="text-sm font-semibold text-gray-800">${fab.fechaEntrega ? new Date(fab.fechaEntrega + 'T00:00:00').toLocaleDateString('es-ES', {day: '2-digit', month: 'long'}) : '-'}</p>
    </div>
</div>

                    ${fab.observaciones ? `
                        <div class="mb-4">
                            <p class="text-xs text-gray-500 mb-1">Observaciones</p>
                            <p class="text-sm text-gray-700 bg-gray-50 p-3 rounded">${fab.observaciones}</p>
                        </div>
                    ` : ''}

                    <div class="flex gap-2 pt-4 border-t">
                        <button
                            onclick="cambiarEstado(${fab.id}, '${ESTADOS.PENDIENTE}')"
                            ${fab.estado === ESTADOS.PENDIENTE ? 'disabled' : ''}
                            class="flex-1 px-3 py-2 text-sm rounded bg-yellow-100 text-yellow-800 hover:bg-yellow-200 disabled:opacity-50 disabled:cursor-not-allowed transition"
                        >
                            Pendiente
                        </button>
                        <button
                            onclick="cambiarEstado(${fab.id}, '${ESTADOS.EN_PROCESO}')"
                            ${fab.estado === ESTADOS.EN_PROCESO ? 'disabled' : ''}
                            class="flex-1 px-3 py-2 text-sm rounded bg-blue-100 text-blue-800 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed transition"
                        >
                            En Proceso
                        </button>
                        <button
                            onclick="cambiarEstado(${fab.id}, '${ESTADOS.COMPLETADA}')"
                            ${fab.estado === ESTADOS.COMPLETADA ? 'disabled' : ''}
                            class="flex-1 px-3 py-2 text-sm rounded bg-green-100 text-green-800 hover:bg-green-200 disabled:opacity-50 disabled:cursor-not-allowed transition"
                        >
                            Completada
                        </button>
                    </div>
                </div>
            `;
        }

        function renderModal() {
            const fab = state.fabricacionSeleccionada 
                ? state.fabricaciones.find(f => f.id === state.fabricacionSeleccionada)
                : null;

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">
                            ${fab ? 'Editar Fabricaci√≥n' : 'Nueva Fabricaci√≥n'}
                        </h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    N√∫mero de Semana *
                                </label>
                                <input
                                    type="number"
                                    id="numeroSemana"
                                    value="${fab ? fab.numeroSemana : ''}"
                                    min="1"
                                    max="53"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    A√±o *
                                </label>
                                <input
                                    type="number"
                                    id="anio"
                                    value="${fab ? fab.anio : new Date().getFullYear()}"
                                    min="2020"
                                    max="2030"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Producto *
                                </label>
                                <input
                                    type="text"
                                    id="producto"
                                    value="${fab ? fab.producto : ''}"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Cantidad *
                                </label>
                                <input
                                    type="number"
                                    id="cantidad"
                                    value="${fab ? fab.cantidad : ''}"
                                    min="1"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>


                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Fecha de Fabricaci√≥n
                                </label>
                                <input
                                    type="date"
                                    id="fechaEntrega"
                                    value="${fab ? (fab.fechaEntrega || '') : ''}"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Observaciones (opcional)
                                </label>
                                <textarea
                                    id="observaciones"
                                    rows="3"
                                    placeholder="A√±ade cualquier observaci√≥n relevante..."
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >${fab ? (fab.observaciones || '') : ''}</textarea>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button
                                    onclick="cerrarModal()"
                                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
                                >
                                    Cancelar
                                </button>
                                <button
                                    onclick="guardarFabricacion()"
                                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                >
                                    Guardar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHistorial() {
            const fab = state.fabricaciones.find(f => f.id === state.fabricacionSeleccionada);
            if (!fab) return '';

            return `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">
                            Historial: ${fab.producto}
                        </h2>
                        <button
                            onclick="cambiarVista('lista')"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                        >
                            Volver
                        </button>
                    </div>

                    <div class="space-y-4">
                        ${fab.historial.map(entrada => {
                            const fecha = new Date(entrada.fecha).toLocaleDateString('es-ES', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            return `
                                <div class="border-l-4 border-blue-500 pl-4 py-2">
                                    <div class="flex justify-between items-start mb-1">
                                        <p class="font-semibold text-gray-800">${entrada.accion}</p>
                                        <p class="text-xs text-gray-500">${fecha}</p>
                                    </div>
                                    <p class="text-sm text-gray-600">Por: ${entrada.usuario}</p>
                                    <p class="text-sm text-gray-700 mt-1">${entrada.detalle}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderCalendario() {
            // Obtener a√±os disponibles
            const aniosDisponibles = [...new Set(state.fabricaciones.map(f => f.anio))].sort();
            if (aniosDisponibles.length === 0) {
                aniosDisponibles.push(new Date().getFullYear());
            }

            // Agrupar fabricaciones por semana y a√±o
            const fabricacionesPorSemana = {};
            state.fabricaciones
                .filter(f => f.anio === state.anioCalendario)
                .forEach(fab => {
                    const key = fab.numeroSemana;
                    if (!fabricacionesPorSemana[key]) {
                        fabricacionesPorSemana[key] = {
                            total: 0,
                            pendientes: 0,
                            enProceso: 0,
                            completadas: 0,
                            fabricaciones: []
                        };
                    }
                    fabricacionesPorSemana[key].total++;
                    fabricacionesPorSemana[key].fabricaciones.push(fab);
                    if (fab.estado === ESTADOS.PENDIENTE) fabricacionesPorSemana[key].pendientes++;
                    if (fab.estado === ESTADOS.EN_PROCESO) fabricacionesPorSemana[key].enProceso++;
                    if (fab.estado === ESTADOS.COMPLETADA) fabricacionesPorSemana[key].completadas++;
                });

            // Generar semanas del a√±o
            const semanas = [];
            for (let i = 1; i <= 52; i++) {
                semanas.push(i);
            }

            return `
                <div class="space-y-6">
                    <!-- Selector de a√±o -->
                    <div class="bg-white rounded-lg shadow-md p-4 flex items-center justify-between">
                        <h2 class="text-2xl font-bold text-gray-800">Calendario de Fabricaciones</h2>
                        <div class="flex items-center gap-4">
                            <button
                                onclick="cambiarAnioCalendario(-1)"
                                class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"
                            >
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <span class="text-2xl font-bold text-blue-600">${state.anioCalendario}</span>
                            <button
                                onclick="cambiarAnioCalendario(1)"
                                class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"
                            >
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Leyenda -->
                    <div class="bg-white rounded-lg shadow-md p-4">
                        <div class="flex flex-wrap gap-4 items-center">
                            <span class="text-sm font-medium text-gray-700">Leyenda:</span>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-yellow-100 border-2 border-yellow-400 rounded"></div>
                                <span class="text-sm text-gray-600">Pendiente</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-blue-100 border-2 border-blue-400 rounded"></div>
                                <span class="text-sm text-gray-600">En Proceso</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-100 border-2 border-green-400 rounded"></div>
                                <span class="text-sm text-gray-600">Completada</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gray-100 border-2 border-gray-300 rounded"></div>
                                <span class="text-sm text-gray-600">Sin fabricaciones</span>
                            </div>
                        </div>
                    </div>

                    <!-- Calendario de semanas -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="grid grid-cols-4 md:grid-cols-8 lg:grid-cols-13 gap-3">
                            ${semanas.map(semana => {
                                const data = fabricacionesPorSemana[semana];
                                const tieneData = data && data.total > 0;
                                
                                let bgColor = 'bg-gray-100 border-gray-300';
                                let textColor = 'text-gray-400';
                                let borderColor = 'border-gray-300';
                                
                                if (tieneData) {
                                    // Color seg√∫n el estado predominante
                                    if (data.pendientes >= data.enProceso && data.pendientes >= data.completadas) {
                                        bgColor = 'bg-yellow-100';
                                        borderColor = 'border-yellow-400';
                                        textColor = 'text-yellow-800';
                                    } else if (data.enProceso >= data.completadas) {
                                        bgColor = 'bg-blue-100';
                                        borderColor = 'border-blue-400';
                                        textColor = 'text-blue-800';
                                    } else {
                                        bgColor = 'bg-green-100';
                                        borderColor = 'border-green-400';
                                        textColor = 'text-green-800';
                                    }
                                }

                                return `
                                    <button
                                        onclick="${tieneData ? `verSemana(${semana})` : ''}"
                                        class="aspect-square ${bgColor} border-2 ${borderColor} rounded-lg p-2 transition hover:shadow-md ${tieneData ? 'cursor-pointer hover:scale-105' : 'cursor-default'}"
                                        title="${tieneData ? `Semana ${semana}: ${data.total} fabricaci√≥n(es)` : `Semana ${semana}: Sin fabricaciones`}"
                                    >
                                        <div class="flex flex-col items-center justify-center h-full">
                                            <span class="text-xs font-medium ${textColor}">S${semana}</span>
                                            ${tieneData ? `<span class="text-lg font-bold ${textColor}">${data.total}</span>` : ''}
                                        </div>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Detalle de semana seleccionada -->
                    ${state.semanaSeleccionada ? `
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">
                                    Semana ${state.semanaSeleccionada} - ${state.anioCalendario}
                                </h3>
                                <button
                                    onclick="cerrarSemana()"
                                    class="text-gray-500 hover:text-gray-700"
                                >
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            ${fabricacionesPorSemana[state.semanaSeleccionada] ? `
                                <div class="grid grid-cols-3 gap-4 mb-4">
                                    <div class="bg-yellow-50 rounded-lg p-3 text-center">
                                        <p class="text-2xl font-bold text-yellow-800">${fabricacionesPorSemana[state.semanaSeleccionada].pendientes}</p>
                                        <p class="text-xs text-yellow-600">Pendientes</p>
                                    </div>
                                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                                        <p class="text-2xl font-bold text-blue-800">${fabricacionesPorSemana[state.semanaSeleccionada].enProceso}</p>
                                        <p class="text-xs text-blue-600">En Proceso</p>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-3 text-center">
                                        <p class="text-2xl font-bold text-green-800">${fabricacionesPorSemana[state.semanaSeleccionada].completadas}</p>
                                        <p class="text-xs text-green-600">Completadas</p>
                                    </div>
                                </div>

                                <div class="space-y-3">
                                    ${fabricacionesPorSemana[state.semanaSeleccionada].fabricaciones.map(fab => {
                                        const colorEstado = {
                                            [ESTADOS.PENDIENTE]: 'bg-yellow-100 text-yellow-800 border-yellow-300',
                                            [ESTADOS.EN_PROCESO]: 'bg-blue-100 text-blue-800 border-blue-300',
                                            [ESTADOS.COMPLETADA]: 'bg-green-100 text-green-800 border-green-300'
                                        };
                                        return `
                                            <div class="border-l-4 ${colorEstado[fab.estado]} pl-4 py-2">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="font-semibold text-gray-800">${fab.producto}</p>
                                                        <p class="text-sm text-gray-600">Cantidad: ${fab.cantidad} | Por: ${fab.solicitante}</p>
                                                        ${fab.observaciones ? `<p class="text-xs text-gray-500 mt-1">${fab.observaciones}</p>` : ''}
                                                    </div>
                                                    <span class="px-2 py-1 rounded text-xs font-medium ${colorEstado[fab.estado].split(' ')[0]} ${colorEstado[fab.estado].split(' ')[1]}">
                                                        ${fab.estado}
                                                    </span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderEstadisticas() {
            const porSemana = {};
            const porProducto = {};

            state.fabricaciones.forEach(fab => {
                porSemana[fab.numeroSemana] = (porSemana[fab.numeroSemana] || 0) + 1;
                porProducto[fab.producto] = (porProducto[fab.producto] || 0) + 1;
            });

            const maxSemana = Math.max(...Object.values(porSemana), 1);
            const maxProducto = Math.max(...Object.values(porProducto), 1);
            const estadisticas = getEstadisticas();

            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Resumen General</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-gray-50 rounded-lg">
                                <p class="text-3xl font-bold text-gray-800">${estadisticas.total}</p>
                                <p class="text-sm text-gray-600">Total Fabricaciones</p>
                            </div>
                            <div class="text-center p-4 bg-yellow-50 rounded-lg">
                                <p class="text-3xl font-bold text-yellow-800">${estadisticas.pendientes}</p>
                                <p class="text-sm text-yellow-700">Pendientes</p>
                            </div>
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <p class="text-3xl font-bold text-blue-800">${estadisticas.enProceso}</p>
                                <p class="text-sm text-blue-700">En Proceso</p>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <p class="text-3xl font-bold text-green-800">${estadisticas.completadas}</p>
                                <p class="text-sm text-green-700">Completadas</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Fabricaciones por Semana</h2>
                        <div class="space-y-2">
                            ${Object.entries(porSemana)
                                .sort(([a], [b]) => Number(a) - Number(b))
                                .map(([semana, cantidad]) => `
                                    <div class="flex items-center gap-4">
                                        <span class="w-20 text-sm font-medium text-gray-700">Semana ${semana}</span>
                                        <div class="flex-1 bg-gray-200 rounded-full h-6">
                                            <div
                                                class="bg-blue-500 h-6 rounded-full flex items-center justify-end pr-2"
                                                style="width: ${(cantidad / maxSemana) * 100}%; min-width: 40px"
                                            >
                                                <span class="text-xs text-white font-semibold">${cantidad}</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Fabricaciones por Producto</h2>
                        <div class="space-y-2">
                            ${Object.entries(porProducto)
                                .sort(([, a], [, b]) => b - a)
                                .map(([producto, cantidad]) => `
                                    <div class="flex items-center gap-4">
                                        <span class="w-64 text-sm font-medium text-gray-700" title="${producto}">${producto}</span>
                                        <div class="flex-1 bg-gray-200 rounded-full h-6">
                                            <div
                                                class="bg-green-500 h-6 rounded-full flex items-center justify-end pr-2"
                                                style="width: ${(cantidad / maxProducto) * 100}%; min-width: 40px"
                                            >
                                                <span class="text-xs text-white font-semibold">${cantidad}</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Funciones globales
        window.cambiarVista = function(vista) {
            state.vistaActual = vista;
            if (vista === 'lista') {
                state.fabricacionSeleccionada = null;
            }
            render();
        };

        window.abrirModal = function(id) {
            state.fabricacionSeleccionada = id;
            state.modoEdicion = true;
            render();
        };

        window.cerrarModal = function() {
            state.modoEdicion = false;
            state.fabricacionSeleccionada = null;
            render();
        };

        window.guardarFabricacion = async function() {
            const numeroSemana = document.getElementById('numeroSemana').value;
            const anio = document.getElementById('anio').value;
            const producto = document.getElementById('producto').value;
            const cantidad = document.getElementById('cantidad').value;
            const diasFabricacion = document.getElementById('diasFabricacion').value;
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            const observaciones = document.getElementById('observaciones').value;

            if (!numeroSemana || !anio || !producto || !cantidad) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }

            const datos = {
                numeroSemana,
                anio,
                producto,
                cantidad,
                diasFabricacion,
                fechaEntrega,
                observaciones
            };

            if (state.fabricacionSeleccionada) {
                await actualizarFabricacion(state.fabricacionSeleccionada, datos);
            } else {
                await crearFabricacion(datos);
            }

            cerrarModal();
        };

        window.cambiarEstado = async function(id, nuevoEstado) {
            await actualizarFabricacion(id, { estado: nuevoEstado });
        };

        window.verHistorial = function(id) {
            state.fabricacionSeleccionada = id;
            state.vistaActual = 'historial';
            render();
        };

        window.cambiarAnioCalendario = function(cambio) {
            state.anioCalendario += cambio;
            render();
        };

        window.verSemana = function(semana) {
            state.semanaSeleccionada = semana;
            render();
        };

        window.cerrarSemana = function() {
            state.semanaSeleccionada = null;
            render();
        };

        // Inicializar
        cargarFabricaciones();
    </script>
</body>
</html>